---
title: "JMJPFU-FeatureEng"
output: html_notebook
---

# JMJPFU
### 5-April-2017

This notebook is to do feature engineering and create the feature space. The process is as follows

1. Take a chunk of text and convert it into various artefact vectors i.e ( Room, Food , Staff, facility etc). The artefact vectors will have the frequency score also. 

2. For each of the template find a probability space for the artefact vector.
3. Compare the artefact vector with the templates and find similarity score for the feature. The similarity score will be calculated by first merging the artefact vector with the template and then finding the similarity of probabilities and then finding a l2 or l1 norm. The similarity score will become the feature value.
4. For each text find the features and then create the training set.

# JMJPFU
### 10-April-2017

### Initial tasks : Loading Library Files

```{r}
library(rvest)
library(dplyr)
library(tm)
library(ngram)
library(stringr)
library(wordcloud)
```


### Experiment 1 : Taking a text and converting into the artefact related templates

Artefacts 

Room, Food, Restaurant, Staff, Lobby, Reception,Transfer,Facilities, Recommend.

```{r}

# Step1 :Taking the relevant text: Filtering out data with class 0
hotelText <- hoteldatDf %>% filter(class != 0) 

# Step 2 : Creating the initial tdm for the first text

 analTdm <- tdmCreator(hotelText[1:1])
 
 # Step 3 : Creating the initial template
 
 compTemplate <- templateCreate(analTdm,'room',0.30) 

 # Step 4 : Take the relevant template of the artefact and do the merge
 
 delCompare <- merge(roomdel,compTemplate,all.x = TRUE)
 
 # Step 5 : Find a consolidated score
 
 conScore <- sum(delCompare[,2]*delCompare[,3],na.rm = TRUE)

```

Thank you Lord for the insights during the experiment.

Now to create a function to handle this feature engineering task. The process of the function should be as follows

1. Provide the text data frame as an input to the function
2. Create an empty data frame whose number of rows is equivalent to the text which is to be analysed. The columns will be equivalent to the number of templates for each of the artefacts
3. Take each text and then calculate the frequency and association scores for each artefact.
4. Compare the frequency score with each template for the archetype and calculate the similarity score. 
5. The similarity score will form the consolidated number which will go against the empty data frame.


```{r}

similFeat <- function(textDf){
  
  # textDf is the dataframe which is fed to the function to extract features
  
  # Finding the number of rows of the data frame
  nrw <- nrow(textDf)
  # Defining the empty data frame
  featDf <- data.frame(matrix(nrow=nrw,ncol=45)) ##** This can be revised. The number of columns may need revision
  # Creating the term document matrix for the text
  
  analTdm <- tdmCreator(textDf[3,1])
  
  
   # Start a for loop to loop over all the text data
  
  
  # Creating another function internally to do the feature calculation
  featCreate <- function(analTdm,arte,thresh,template){
    # analTdm : This is the TDM which is passed internally in the function
    # arte : This is the aretefact which is passed as a charachter eg. "room"
    # thresh : This is the threshold for the association like 0.3. This can be custom provided
    # template : This is the template which is required to be given for comparison
    
    #Creating the initial template
 
    compTemplate <- templateCreate(analTdm,arte,thresh) 
    
    if(nrow(compTemplate) > 0){
      
      # Take the delight template of the artefact and do the merge only if the template has any data
      
      delCompare <- merge(template,compTemplate,all.x = TRUE)
      
      conScore <- sum(delCompare[,2]*delCompare[,3],na.rm = TRUE)
    }else{
      
      conScore <- 0 
    } # End of the if condition
    
    conScore # return the consolidated score
  } # End of the function
  
  
  
  for(i in 1:nrw){
    
    
    ### Creating templates for Room
    
    featDf[i,1] <- featCreate(analTdm,'room',0.3,roomdel) # Delight
    featDf[i,2] <- featCreate(analTdm,'room',0.3,roomSat) # Satisfied
    featDf[i,3] <- featCreate(analTdm,'room',0.3,roomok) # OK
    featDf[i,4] <- featCreate(analTdm,'room',0.3,roomdis) # Dissatisfied
    featDf[i,5] <- featCreate(analTdm,'room',0.3,roomAng) # Angry
    
    #print("room")
     ### Creating templates for Food
    
    featDf[i,6] <- featCreate(analTdm,'food',0.3,resdel) # Delight
    featDf[i,7] <- featCreate(analTdm,'food',0.3,foodSat) # Satisfied
    featDf[i,8] <- featCreate(analTdm,'food',0.3,resok) # OK
    featDf[i,9] <- featCreate(analTdm,'food',0.3,restdis) # Dissatisfied
    featDf[i,10] <- featCreate(analTdm,'food',0.3,restAng) # Angry
    
    #print("Food")
    ### Creating templates for Restaurant
    
    featDf[i,11] <- featCreate(analTdm,'restaurant',0.3,resdel) # Delight
    featDf[i,12] <- featCreate(analTdm,'restaurant',0.3,restSat) # Satisfied
    featDf[i,13] <- featCreate(analTdm,'restaurant',0.3,resok) # OK
    featDf[i,14] <- featCreate(analTdm,'restaurant',0.3,restdis) # Dissatisfied
    featDf[i,15] <- featCreate(analTdm,'restaurant',0.3,restAng) # Angry
    
    #print("restaurant")
    
    ### Creating templates for Staff
    
    featDf[i,16] <- featCreate(analTdm,'staff',0.3,staffdel) # Delight
    featDf[i,17] <- featCreate(analTdm,'staff',0.3,staffSat) # Satisfied
    featDf[i,18] <- featCreate(analTdm,'staff',0.3,staffok) # OK
    featDf[i,19] <- featCreate(analTdm,'staff',0.3,staffdis) # Dissatisfied
    featDf[i,20] <- featCreate(analTdm,'staff',0.3,staffAng) # Angry
    
    #print("staff")
    ### Creating templates for Lobby
    
    featDf[i,21] <- featCreate(analTdm,'lobby',0.3,lobbydel) # Delight
    featDf[i,22] <- featCreate(analTdm,'lobby',0.3,lobbySat) # Satisfied
    featDf[i,23] <- featCreate(analTdm,'lobby',0.3,lobbyok) # OK
    #featDf[i,24] <- featCreate(analTdm,'lobby',0.3,staffdis) # Dissatisfied - No template for now
    # featDf[i,25] <- featCreate(analTdm,'lobby',0.3,staffAng) # Angry - No template for now
    
    #print("lobby")
 
    ### Creating templates for Reception
    
    featDf[i,24] <- featCreate(analTdm,'reception',0.3,recepdel) # Delight
    featDf[i,25] <- featCreate(analTdm,'reception',0.3,receptionSat) # Satisfied
    featDf[i,26] <- featCreate(analTdm,'reception',0.3,recepok) # OK
    # featDf[i,27] <- featCreate(analTdm,'reception',0.3,staffdis) # Dissatisfied - No template
    # featDf[i,28] <- featCreate(analTdm,'reception',0.3,staffAng) # Angry - No Template
    
    #print("reception")
    ### Creating templates for Transfer
    
    featDf[i,27] <- featCreate(analTdm,'transfer',0.3,trandel) # Delight
    #featDf[i,28] <- featCreate(analTdm,'transfer',0.3,receptionSat) # Satisfied - Not template
    # featDf[i,29] <- featCreate(analTdm,'transfer',0.3,recepok) # OK - No Template
    # featDf[i,27] <- featCreate(analTdm,'transfer',0.3,staffdis) # Dissatisfied - No template
    # featDf[i,28] <- featCreate(analTdm,'transfer',0.3,staffAng) # Angry - No Template
  
    #print("transfer")
    ### Creating templates for Facilities
    
    featDf[i,28] <- featCreate(analTdm,'facilities',0.3,facildel) # Delight
    featDf[i,29] <- featCreate(analTdm,'facilities',0.3,facilSat) # Satisfied
    featDf[i,30] <- featCreate(analTdm,'facilities',0.3,facilok) # OK 
    # featDf[i,27] <- featCreate(analTdm,'facilities',0.3,staffdis) # Dissatisfied - No template
    # featDf[i,28] <- featCreate(analTdm,'facilities',0.3,staffAng) # Angry - No Template
    
    #print("facilities")
     ### Creating templates for Recomend
    
    featDf[i,31] <- featCreate(analTdm,'recommend',0.3,reccodel) # Delight
    # featDf[i,32] <- featCreate(analTdm,'recommend',0.3,facilSat) # Satisfied - No template
    # featDf[i,33] <- featCreate(analTdm,'recommend',0.3,facilok) # OK - No Template
    # featDf[i,27] <- featCreate(analTdm,'recommend',0.3,staffdis) # Dissatisfied - No template
    # featDf[i,28] <- featCreate(analTdm,'recommend',0.3,staffAng) # Angry - No Template
    
    #print("recommend")
    
    } # End of the for loop for looping over the text data
  
  
  
  names(featDf) <- c("roomdel","roomSat","roomok","roomdis","roomAng","resdel","foodSat","resok","restdis","restAng","resdel","restSat","resok","restdis","restAng","staffdel","staffSat","staffok","staffdis","staffAng","lobbydel","lobbySat","lobbyok","recepdel","receptionSat","recepok","trandel","facildel","facilSat","facilok","reccodel")
  
  # Returns the featDF data frame
  
  featDf 
} # End of the function

```

# JMJPFU
### 11-Apr-2017

Lest now test the feature engineering function

```{r}
hotelDat <- hotelText %>% select(hoteldatDf)

featDf <- similFeat(hotelDat)
```

# JMJPFU
### 12-April-2017

So from the experiment, the approach of finding the term document association with the current method is flawed. What needs to be done for comparison of the template with each document is to do it with the ngram model.

The process should be as follows

1. Find all 6 word n-gram.
2. Take out only those n-grams which have the archetypes in it. 
3. Look for the words which occur in the n-gram within each word distance i.e give a rating to a word which is adjacent to the archetype, one word away, two word away etc to each archetypes.
4. 

### Experiment 2 : For creating n-gram from the Text

```{r}
# Taking a text at a time

tempText <- hotelText$hoteldatDf[1]

# Converting all the list elements to a dataframe
textDf <- do.call("rbind",lapply(tempText,as.data.frame)) # hiltSatisfacDf > textDf
# Converting the factors to character
textDf <- data.frame(lapply(textDf,as.character),stringsAsFactors = FALSE)
# Providing a name to the text column
names(textDf) <- "text"
# Converting this into a corpus  
textCorp <- Corpus(VectorSource(textDf$text)) #  hiltSatCorp > textCorp 

# textCorp <- textDf$text

#textCorp <- tm_map(textCorp, PlainTextDocument)

# Converting to lowercase
textCorp <- tm_map(textCorp,tolower) # yes

textCorp <- tm_map(textCorp,removeWords,c("the","was","i","at","a","when","is","and","has","for","of","are","to","an","it","in","be","if","on","since","as","had","so","he","him","me","her","she","its","that","its","been","he","there"))

#textCorp <- tm_map(textCorp,removeWords,stopwords('english'))
# Remove punctuations
textCorp <- tm_map(textCorp,removePunctuation)
# Remove numbers
textCorp <- tm_map(textCorp,removeNumbers)
# Remove whitespace
textCorp <- tm_map(textCorp,stripWhitespace)

# Removing stopwords
#stopwords_regex = paste(stopwords('en'), collapse = '\\b|\\b')
#stopwords_regex = paste0('\\b', stopwords_regex, '\\b')

#textCorp = stringr::str_replace_all(textCorp, stopwords_regex, '')

#


# Doing the stemming
#textCorp <- tm_map(textCorp,stemDocument)
# Converting the text to Plaintext
 #textCorp <- tm_map(textCorp, PlainTextDocument)
# Converting to a corpus for making TDM
## Experiments



textCorp1 <- inspect(textCorp)[[1]]

#textCop1 <- textCorp[1]
# Creating required ngram 
textNgram <- get.ngrams(ngram(textCorp1,n=6))

ngramDf <- data.frame(textNgram)


```

Now to split the ngram and remove empty spaces and store each word in new column. 

Another observation is only when the whitespace was stripped, the ngram worked well without any hitches

```{r}

# Below will split each ngram into different words
tesStr <- str_split(ngramDf[1,1],pattern = " ")

# The below will let us know the number of words in the string

length(tesStr[[1]])

# Let us try some grep functions to get the archetypes we want

tesGrep <- grep("room*",ngramDf$textNgram,value = TRUE)

tesGrep <- grep(c("food*","restaurant*"),ngramDf$textNgram,value = TRUE)
# Next we calculate the weights of each word from the archetype based on the distance from archetype

```
Thank you Lord for the progress so far.

# Tomorrow

Calculation of the weights and then the distance scores to find good associations.
